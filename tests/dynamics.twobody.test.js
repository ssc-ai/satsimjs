import { vallado, rv2period, rv2ecc, rv2coe } from '../src/engine/dynamics/twobody';
import { Cartesian3 } from 'cesium';

describe('twobody', () => {

    const mu = 398600441800000.0
    const numiter = 350;
    const eps = 1e-14;

    const ro1 = new Cartesian3(-605792.21660, -5870229.51108, 3493053.19896);
    const vo1 = new Cartesian3(-1568.25429, -3702.34891, -6479.48395);

    const ro2 = new Cartesian3(-27739093.33242799, -2692255.908557946, 9510190.36914625);
    const vo2 = new Cartesian3(-1886.889113303305, -2370.850540911774, 5779.199448104134);

    test('should calculate classical orbital elements (COE) correctly', () => {

        // expected output from Vallado's MATLAB code
        const expectedCOE1 = [6860755.382175609, 0.00106398573767354, 1.704346105050908, 1.388357215174171, 1.463640333262393, 1.138182142500424]
        const ecc1 = rv2ecc(mu, ro1, vo1);

        expect(ecc1).toBeCloseTo(expectedCOE1[1], 16);

        const coe1 = rv2coe(mu, ro1, vo1);
        for (let i = 0; i < expectedCOE1.length; i++) {
            expect(coe1[i]).toBeCloseTo(expectedCOE1[i], 8);
        }

        // expected output from Vallado's MATLAB code
        const expectedCOE2 = [60209040.44608618, 1.828267146948679, 1.168288532142409, 3.092545852463909, 5.679218487096275, 0.9626133035303527]

        const ecc2 = rv2ecc(mu, ro2, vo2);

        expect(ecc2).toBeCloseTo(expectedCOE2[1], 15);

        const coe2 = rv2coe(mu, ro2, vo2);
        for (let i = 0; i < expectedCOE2.length; i++) {
            expect(coe2[i]).toBeCloseTo(expectedCOE2[i], 7);
        }

    });

    test('should calculate period correctly', () => {

        const period1 = rv2period(mu, ro1, vo1);
        expect(period1).toEqual(5655.481947582134);

        const period2 = rv2period(mu, ro2, vo2);
        expect(period2).toEqual(Infinity);


    });

    test('should propagate state vectors correctly with vallado', () => {

        // expected output from Vallado's MATLAB code
        const expected1 = [
            [0.000000, -605792.21660, -5870229.51108, 3493053.19896, -1568.25429, -3702.34891, -6479.48395],   
            [100.000000, -758555.4463362538, -6203466.893758777, 2824876.750810726, -1483.867999040342, -2955.575042487661, -6870.259019787754],   
            [200.000000, -901956.1128556451, -6460136.593939571, 2121833.059044098, -1381.198105504367, -2172.577951076066, -7176.119453441225],   
            [300.000000, -1034228.052129311, -6637097.765837283, 1392608.524186409, -1261.524706473484, -1363.049809721384, -7393.346693229219],   
            [400.000000, -1153743.673667741, -6732195.53012057, 646206.6962940264, -1126.336212969514, -536.9972302222072, -7519.322362378448],   
            [500.000000, -1259033.862670426, -6744286.208524212, -108163.3263233257, -977.3103695176321, 295.3833297589385, -7552.557585076086],   
            [600.000000, -1348805.870006935, -6673250.003263706, -861200.7246550606, -816.2930373648267, 1123.831813508904, -7492.708171724797],   
            [700.000000, -1421958.980593706, -6519991.034983227, -1603627.59630089, -645.2750286978664, 1938.150886645825, -7340.575638706167],   
            [800.000000, -1477597.780396711, -6286424.809456524, -2326302.991844825, -466.3672970439768, 2728.3307868001, -7098.094208396757],   
            [900.000000, -1515042.87350481, -5975453.335415966, -3020334.962604705, -281.7748021977468, 3484.671207606494, -6768.304102113709],   
            [1000.000000, -1533838.933023138, -5590928.261994528, -3677189.271221133, -93.76937669297138, 4197.898791281262, -6355.311594349327],   
        ]

        for (let i = 0; i < expected1.length; i++) {
            const result = vallado(mu, ro1, vo1, expected1[i][0], numiter);
            expect(Cartesian3.equalsEpsilon(result.position, new Cartesian3(expected1[i][1], expected1[i][2], expected1[i][3]), eps)).toEqual(true);
            expect(Cartesian3.equalsEpsilon(result.velocity, new Cartesian3(expected1[i][4], expected1[i][5], expected1[i][6]), eps)).toEqual(true);
        }

        // expected output from Vallado's MATLAB code
        const expected2 = [
            [0.000000, -27739093.33242799, -2692255.908557946, 9510190.36914625, -1886.889113303305, -2370.850540911774, 5779.199448104134],   
            [100.000000, -27925640.55171997, -2929127.51678184, 10087362.95423781, -1844.286813100734, -2366.549379528035, 5764.203273404959],   
            [200.000000, -28107996.3555098, -3165559.699943866, 10663022.0077874, -1803.054305086834, -2362.065629750349, 5748.936491141751],   
            [300.000000, -28286295.76424982, -3401535.250191436, 11237142.70904981, -1763.152330601211, -2357.420053416114, 5733.443286922854],   
            [400.000000, -28460669.85223538, -3637038.95973046, 11809704.47491743, -1724.541270939063, -2352.631902383493, 5717.764262547755],   
            [500.000000, -28631245.72469725, -3872057.473618962, 12380690.61194233, -1687.181403048315, -2347.718994655777, 5701.936644036228],   
            [600.000000, -28798146.5186495, -4106579.150239919, 12950087.98910898, -1651.033119516182, -2342.697791636528, 5685.994488198038],   
            [700.000000, -28961491.42409192, -4340593.929508788, 13517886.73109617, -1616.057116225842, -2337.583475401307, 5669.968885518626],   
            [800.000000, -29121395.72249749, -4574093.208770701, 14084079.93156902, -1582.214550926161, -2332.390025085274, 5653.888157621175],   
            [900.000000, -29277970.83983102, -4807069.726261715, 14648663.38588917, -1549.467175784435, -2327.130291671792, 5637.778047981556],   
            [1000.000000, -29431324.41164294, -5039517.451945264, 15211635.34251756, -1517.777446796277, -2321.816070627477, 5621.661904926118],
        ]

        for (let i = 0; i < expected2.length; i++) {
            const result = vallado(mu, ro2, vo2, expected2[i][0], numiter);
            expect(Cartesian3.equalsEpsilon(result.position, new Cartesian3(expected2[i][1], expected2[i][2], expected2[i][3]), eps)).toEqual(true);
            expect(Cartesian3.equalsEpsilon(result.velocity, new Cartesian3(expected2[i][4], expected2[i][5], expected2[i][6]), eps)).toEqual(true);
        }
    });
});
